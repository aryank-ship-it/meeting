<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Book Appointment</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .modal-container { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:15px; }
    .appointment-modal { background: white; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.08); max-width:580px; width:100%; padding:24px; }
    .close-btn { position:absolute; right:15px; top:15px; background:none; border:none; font-size:22px; color:#999; cursor:pointer; }
    .modal-title { color:#0d6efd; font-size:22px; font-weight:600; margin-bottom:4px; }
    .modal-subtitle { color:#6c757d; font-size:13px; margin-bottom:20px; }
    .form-label { font-weight:500; color:#212529; font-size:13px; margin-bottom:4px; }
    .required { color:#dc3545; margin-left:2px; }
    .form-control, .form-select { border:1px solid #dee2e6; border-radius:4px; padding:7px 10px; font-size:14px; }
    .form-control:focus, .form-select:focus { border-color:#0d6efd; box-shadow:0 0 0 2px rgba(13,110,253,0.08); }
    .add-guest-btn { background:none; border:none; color:#0d6efd; font-size:13px; padding:0; margin-bottom:8px; cursor:pointer; }
    .btn-reset { padding:8px 20px; border:1px solid #dee2e6; color:#666; background:white; border-radius:4px; font-size:14px; }
    .btn-submit { padding:8px 24px; background-color:#0d6efd; color:white; border-radius:4px; border:none; font-size:14px; }
    .button-group { display:flex; justify-content:space-between; margin-top:20px; }
    .guest-row { display:flex; gap:6px; margin-bottom:6px; }
    .section { margin-bottom:16px; }
    .row-compact { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .time-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .form-check { margin-bottom:0; }
    .form-check-label { font-size:13px; }
  </style>
</head>
<body>
  <div class="modal-container">
    <div class="appointment-modal position-relative">
      <button class="close-btn" onclick="closeModal()">×</button>
      <h2 class="modal-title">Book Appointment</h2>
      <p class="modal-subtitle">Schedule a meeting to learn about Deep Enrich</p>

      <form id="bookingForm">
        <!-- Contact Info -->
        <div class="section">
          <div class="row-compact">
            <div>
              <label class="form-label">Name<span class="required">*</span></label>
              <input id="name" class="form-control" required />
            </div>
            <div>
              <label class="form-label">Email<span class="required">*</span></label>
              <input id="email" type="email" class="form-control" required />
            </div>
          </div>
        </div>

        <div class="section">
          <button type="button" class="add-guest-btn" id="addGuestBtn">+ Add Guest</button>
          <div id="guestsContainer"></div>
        </div>

        <div class="section">
          <div class="row-compact">
            <div>
              <label class="form-label">Company</label>
              <input id="companyName" class="form-control" />
            </div>
            <div>
              <label class="form-label">Phone</label>
              <input id="contactNumber" type="tel" class="form-control" />
            </div>
          </div>
        </div>

        <!-- Date & Time -->
        <div class="section">
          <div class="time-row">
            <div>
              <label class="form-label">Date<span class="required">*</span></label>
              <input id="meetingDate" type="date" class="form-control" required />
            </div>
            <div>
              <label class="form-label">Time<span class="required">*</span></label>
              <input id="meetingTime" type="time" class="form-control" required />
            </div>
          </div>
        </div>

        <!-- Message -->
        <div class="section">
          <label class="form-label">Message<span class="required">*</span></label>
          <textarea id="message" rows="3" class="form-control" required></textarea>
        </div>

        <!-- Additional Info -->
        <div class="section">
          <div class="row-compact">
            <div>
              <label class="form-label">Target Industries</label>
              <input id="industries" class="form-control" placeholder="Pharma, IT..." />
            </div>
            <div>
              <label class="form-label">Job Titles</label>
              <input id="jobTitles" class="form-control" placeholder="Director, Manager..." />
            </div>
          </div>
        </div>

        <div class="section">
          <label class="form-label mb-2">Priority</label>
          <div class="d-flex gap-3">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="priority" id="contactOnly" value="contact">
              <label class="form-check-label" for="contactOnly">Contact only</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="priority" id="emailOnly" value="email">
              <label class="form-check-label" for="emailOnly">Email only</label>
            </div>
          </div>
        </div>

        <div class="section">
          <label class="form-label">Monthly Contacts Expected</label>
          <input id="monthlyContacts" class="form-control" />
        </div>

        <div class="button-group">
          <button type="button" class="btn-reset btn" id="btnReset">Reset</button>
          <button type="submit" class="btn-submit btn" id="btnSubmit">Submit</button>
        </div>
      </form>

      <!-- googleStatus removed from public form (moved to Admin dashboard) -->
      <div id="formStatus" style="margin-top:10px; font-size:13px;"></div>
      <div id="successBlock" style="margin-top:10px;"></div>
    </div>
  </div>

  <script>
    // Google status is displayed in the Admin dashboard; remove from public form.

    const guestsContainer = document.getElementById('guestsContainer');
    document.getElementById('addGuestBtn').addEventListener('click', () => {
      const div = document.createElement('div');
      div.className = 'guest-row';
      div.innerHTML = `<input type='email' class='form-control guest-email' placeholder='Guest email'> <button type='button' class='btn btn-sm btn-outline-danger btn-remove'>×</button>`;
      guestsContainer.appendChild(div);
      div.querySelector('.btn-remove').addEventListener('click', () => div.remove());
    });

    const bookingForm = document.getElementById('bookingForm');
    bookingForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btnSubmit = document.getElementById('btnSubmit');
      btnSubmit.disabled = true;
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('contactNumber').value.trim();
      const companyName = document.getElementById('companyName').value.trim();
      const meetingDate = document.getElementById('meetingDate').value;
      const meetingTime = document.getElementById('meetingTime').value;
      const message = document.getElementById('message').value.trim();
      if (!name || !email || !meetingDate || !meetingTime || !message) {
        alert('Please fill required fields');
        btnSubmit.disabled = false;
        return;
      }
      const guestEls = document.querySelectorAll('.guest-email');
      const attendees = [];
      guestEls.forEach(g => { if (g.value.trim()) attendees.push(g.value.trim()); });

      const body = { name, email, phone, message, meetingDate, meetingTime, attendees, companyName, industries: document.getElementById('industries').value, jobTitles: document.getElementById('jobTitles').value, priority: document.querySelector('input[name="priority"]:checked')?.value, monthlyContacts: document.getElementById('monthlyContacts').value };
      try {
        // Immediate feedback: show spinner while waiting for network response
        const statusArea = document.getElementById('formStatus');
        statusArea.innerHTML = `<div class='alert alert-info mb-0'><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Submitting...</div>`;
        const res = await fetch('/send-mail', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const data = await res.json();
        if (res.ok) {
          // Keep 'Submitted' message, and reset form immediately upon success
          statusArea.innerHTML = `<div class='alert alert-success mb-0'>Submitted — Meeting scheduled for <strong>${data.start}</strong>${data.meetLink ? ` — <a href='${data.meetLink}' target='_blank'>Join Meet</a>` : ''}</div>`;
          bookingForm.reset();
          guestsContainer.innerHTML = '';
        } else {
          statusArea.innerHTML = `<div class='alert alert-danger mb-0'>${data.message || 'Failed to schedule meeting'}</div>`;
        }
        } catch (err) {
          console.error('Failed to send', err);
          const statusArea = document.getElementById('formStatus');
          statusArea.innerHTML = `<div class='alert alert-danger mb-0'>Failed to send booking request</div>`;
      } finally {
        btnSubmit.disabled = false;
      }
    });

    document.getElementById('btnReset').addEventListener('click', (e) => { bookingForm.reset(); guestsContainer.innerHTML = ''; });
    function closeModal() { window.history.back(); }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>