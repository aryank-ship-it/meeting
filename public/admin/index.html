<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 0; }
    .sidebar { height: 100vh; background:#f8f9fa; }
  </style>
</head>
<body>
  <div class="d-flex">
    <aside class="sidebar p-3" style="width:250px">
      <h4>Admin</h4>
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link" href="#/dashboard">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="#/meetings">Meetings</a></li>
        <li class="nav-item"><a class="nav-link" href="#/settings">Settings</a></li>
        <li class="nav-item"><a class="nav-link" href="#/logout">Logout</a></li>
      </ul>
    </aside>
    <div class="flex-grow-1 p-4">
      <div id="content"></div>
    </div>
  </div>

  <script>
    // Very simple SPA router + JWT check
    // Always point API calls to the Express backend. If you're seeing 405 errors
    // it's likely because you're serving the admin page from a static server (e.g. Live Server on port 5500).
    // Use http://localhost:5000/admin/index.html or set API_BASE to the proper API server.
    const API_BASE = 'http://localhost:5000';
    const token = () => localStorage.getItem('adminToken');
    function authFetch(url, opts) {
      opts = opts || {};
      opts.headers = opts.headers || {};
      if (token()) opts.headers.Authorization = 'Bearer ' + token();
      // Always prefix with API_BASE
      const target = `${API_BASE}${url}`;
      return fetch(target, opts);
    }

    function goto(hash) { location.hash = hash; render(); }
    async function render() {
      const content = document.getElementById('content');
      const h = location.hash.replace('#','') || '/dashboard';
      if (h === '/login') {
        content.innerHTML = `
          <h2>Admin Login</h2>
          <form id="loginForm">
            <div class="mb-3"><input class="form-control" id="email" placeholder="email"/></div>
            <div class="mb-3"><input class="form-control" id="password" placeholder="password" type="password"/></div>
            <button class="btn btn-primary">Login</button>
          </form>
        `;
        document.getElementById('loginForm').addEventListener('submit', async (e)=>{
          e.preventDefault();
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          const resp = await fetch(`${API_BASE}/admin/login`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email,password})});
          if (resp.ok) {
            const data = await resp.json();
            localStorage.setItem('adminToken', data.token);
            goto('/dashboard');
          } else {
            alert('Login failed');
          }
        });
        return;
      }
      if (!token()) { goto('/login'); return; }

      if (h === '/dashboard' || h === '/') {
        // fetch counts
        const r = await authFetch('/admin/meetings');
        const d = await r.json();
        const meetings = d.meetings || [];
        const total = meetings.length;
        const upcoming = meetings.filter(m => new Date(m.start) > new Date()).length;
        const cancelled = meetings.filter(m => m.status === 'cancelled').length;
        content.innerHTML = `
          <h2>Dashboard</h2>
          <div class="row">
            <div class="col-md-3"><div class="card p-3">Total<br/><strong>${total}</strong></div></div>
            <div class="col-md-3"><div class="card p-3">Upcoming<br/><strong>${upcoming}</strong></div></div>
            <div class="col-md-3"><div class="card p-3">Cancelled<br/><strong>${cancelled}</strong></div></div>
          </div>
        `;
        return;
      }
      if (h === '/meetings') {
        const r = await authFetch('/admin/meetings');
        const d = await r.json();
        const meetings = d.meetings || [];
        content.innerHTML = `
          <h2>Meetings</h2>
          <table class="table table-striped"><thead><tr><th>Name</th><th>Email</th><th>Time</th><th>Link</th><th>Status</th><th>Actions</th></tr></thead><tbody id="meetingsBody"></tbody></table>
        `;
        const tbody = document.getElementById('meetingsBody');
        meetings.forEach(m => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${m.name}</td><td>${m.email}</td><td>${new Date(m.start).toLocaleString()}</td><td>${m.hangoutLink ? `<a href='${m.hangoutLink}' target='_blank'>meet</a>` : ''}</td><td>${m.status}</td><td><button class='btn btn-sm btn-danger cancel' data-id='${m._id}'>Cancel</button> <button class='btn btn-sm btn-secondary delete' data-id='${m._id}'>Delete</button></td>`;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('.cancel').forEach(btn => btn.addEventListener('click', async (e)=>{
          const id = btn.dataset.id;
          if (!confirm('Cancel meeting?')) return;
          const r = await authFetch(`/admin/cancel-meeting/${id}`, { method: 'POST' });
          if (r.ok) { alert('Cancelled'); render(); }
        }));
        document.querySelectorAll('.delete').forEach(btn => btn.addEventListener('click', async (e)=>{
          const id = btn.dataset.id;
          if (!confirm('Delete meeting?')) return;
          const r = await authFetch(`/admin/delete-meeting/${id}`, { method: 'DELETE' });
          if (r.ok) { alert('Deleted'); render(); }
        }));
        return;
      }
      if (h === '/settings') {
        const r = await authFetch('/admin/settings');
        const d = await r.json();
        const settings = d || {};
        content.innerHTML = `
          <h2>Settings</h2>
          <form id='settingsForm'>
            <div class='mb-3'><label class='form-label'>Admin Email</label><input class='form-control' id='adminEmail' value='${settings.adminEmail || ''}'></div>
            <div class='mb-3'><label class='form-label'>Default duration (minutes)</label><input class='form-control' id='defaultDuration' value='${settings.defaultDurationMinutes || 30}'></div>
            <button class='btn btn-primary'>Save</button>
          </form>
        `;
        document.getElementById('settingsForm').addEventListener('submit', async (e) => { e.preventDefault(); const adminEmail = document.getElementById('adminEmail').value; const defaultDuration = parseInt(document.getElementById('defaultDuration').value || '30', 10); const rr = await authFetch('/admin/settings', {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({adminEmail, defaultDurationMinutes: defaultDuration})}); if (rr.ok) alert('Saved'); });
        return;
      }
      if (h === '/logout') { localStorage.removeItem('adminToken'); goto('/login'); return; }
      // default
      goto('/dashboard');
    }
    window.addEventListener('hashchange', render);
    render();
  </script>
</body>
</html>
